{% extends "_base.html" %}

{% block title -%}
  {% if edit_operation == 'new' %}
    New Project
  {% else %}
    {{ project.name }} - {{ edit_operation }}
  {% endif %}
{%- endblock %}
{% block header -%}
  {% if edit_operation == 'new' %}
    New Project
  {% else %}
    {{ project.name }} <small>{{ edit_operation }}</small>
  {% endif %}
{%- endblock %}
{% block content %}
<ul class="list-group" data-bind="foreach:messages">
    <li class="list-group-item" data-bind="text:message_display, css:category_css"></li>
</ul>
<div style="text-align: center; font-size: 2em" data-bind="visible:loading">
    <i class="mdi-device-data-usage spin"></i>
    <span>Loading...</span>
</div>
<div class="panel panel-default">
  <div class="panel-body">
    <div class="form-horizontal bs-component" role="form" action="" id="projectForm" method="POST">
      <input id="inputGithubRepoId" name="github_repo_id" value="{{ project.github_repo_id or '' }}" type="hidden">
      <div class="form-group">
        <label class="col-sm-2 control-label">Repo type</label>
        <ul id="repoTypeTabs" class="nav nav-tabs col-sm-10">
          {% if config.model.github_key and config.model.github_secret and (edit_operation == 'new' or project.github_repo_id) %}
            <li><a id="githubTab" href="#github">GitHub</a></li>
          {% endif %}
          <li id="manualTab" class="active"><a href="#manual">Manual</a></li>
        </ul>
      </div>
      <div class="tab-content">
        <div id="github" class="tab-pane">
          <div class="form-group">
            <label for="inputName" class="col-sm-2 control-label">Settings from</label>
            {% if project.github_repo_id -%}
              <p class="col-sm-10 form-control-static">{{ project.github_repo_id }}</p>
            {%- else -%}
              <ul id="repo-list" class="col-sm-10 form-control-static" style="list-style: none;"></ul>
            {% endif %}
          </div>
        </div>
        <div id="manual" class="tab-pane active">
          <div class="form-group">
            <label for="inputRepo" class="col-sm-2 control-label">Git Repository</label>
            <div class="col-sm-10">
              <input required class="form-control" id="inputRepo" name="repo" placeholder="https://your.repo.url" data-bind="value:project().repo">
            </div>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="inputSlug" class="col-sm-2 control-label">Slug</label>
        <div class="col-sm-10">
          {% if edit_operation == 'new' -%}
            <input required class="form-control" id="inputSlug" name="slug" placeholder="Slug" data-bind="value:project().slug">
            <span class="help-block">Must only contain lowercase letters, numbers, and characters <code>_</code>, <code>-</code>, or <code>.</code></span>
          {%- else -%}
            <p class="form-control-static" data-bind="text:project().slug"></p>
          {% endif %}
        </div>
      </div>
      <div class="form-group">
        <label for="inputName" class="col-sm-2 control-label">Name</label>
        <div class="col-sm-10">
          <input required class="form-control" id="inputName" name="name" placeholder="Name" data-bind="value:project().name">
        </div>
      </div>
      <div class="form-group">
        <label for="inputGithubSecret" class="col-sm-2 control-label">GitHub Webhook Secret</label>
        <div class="col-sm-10">
          <input class="form-control" id="inputGithubSecret" name="github_secret" placeholder="*****">
        </div>
      </div>
      <div class="form-group">
        <label for="inputHipchatApiToken" class="col-sm-2 control-label">HipChat API Token</label>
        <div class="col-sm-10">
          <input class="form-control" type="password" id="inputHipchatApiToken" name="hipchat_api_token" placeholder="*****", data-bind="value:project().hipchat_api_token">
        </div>
      </div>
      <div class="form-group">
        <label for="inputHipchatRoom" class="col-sm-2 control-label">HipChat Room</label>
        <div class="col-sm-10">
          <input class="form-control" id="inputHipchatRoom" name="hipchat_room" data-bind="value:project().hipchat_room">
        </div>
      </div>
      <div class="form-group">
        <div class="col-sm-2">&nbsp;</div>
        <div class="col-sm-10">
          <button class="btn btn-primary" data-bind="click:$root.save">Save</button>
          {% if edit_operation == 'new' -%}
            <a class="btn btn-default" href="/">Cancel</a>
          {%- else -%}
            <a class="btn btn-default" href="/projects/{{ project.slug }}">Cancel</a>
          {%- endif %}
        </div>
      </div>
    </div>
    <script>
        $(document).ready(function() {
            function MessageModel(init_hash) {
                var self = this

                self.message = init_hash['message']
                self.category = init_hash['category']

                self.category_css = ko.computed(function() {
                    return 'list-group-item-' + self.category
                })
                self.category_display = ko.computed(function() {
                    return (self.category.charAt(0).toUpperCase() +
                            self.category.substr(1).toLowerCase())
                })
                self.message_display = ko.computed(function() {
                    return self.category_display() + ': ' + self.message
                })
            }
            function ProjectModel(init_hash) {
                var self = this

                self.slug = ko.observable(init_hash['slug'])
                self.name = ko.observable(init_hash['name'])
                self.repo = ko.observable(init_hash['repo'])

                self.github_repo_id = ko.observable(init_hash['github_repo_id'])

                self.hipchat_room = ko.observable(init_hash['hipchat_room'] || '')
                self.hipchat_api_token = ko.observable('')

                self.form_json = ko.computed(function() {
                    return {
                        'name': self.name(),
                        'repo': self.repo(),
                        // 'github_repo_id': self.github_repo_id(),
                        'hipchat_room': self.hipchat_room(),
                        'hipchat_api_token': self.hipchat_api_token(),
                    }
                })
            }
            function ThisPage() {
                var self = this

                self.messages = ko.observableArray()
                self.loading = ko.observable(true)
                self.slug = ko.observable("{{ project.slug }}")
                self.project = ko.observable(new ProjectModel({}))

                function ajax_fail(jqXHR, textStatus, errorThrown) {
                    var message = (jqXHR.responseJSON || {})['message'] || textStatus
                    self.messages([
                        new MessageModel({'message': message, 'category': 'danger'})
                    ])
                }
                function ajax_always() { self.loading(false) }
                function reload_project() {
                    self.loading(true)
                    $.ajax("/api/v1/projects/" + self.slug(), {
                          'dataType': 'json'
                    })
                        .done(function(project) { self.project(new ProjectModel(project)) })
                        .always(ajax_always)
                        .fail(ajax_fail)
                }
                self.save = function() {
                    self.loading(true)
                    $.ajax("/api/v1/projects/" + self.slug(), {
                          'method': 'POST'
                        , 'data': self.project().form_json()
                        , 'dataType': 'json'
                    })
                        .done(function(project) { console.dir(project) })
                        .always(ajax_always)
                        .fail(ajax_fail)
                }

                reload_project()
            }
            ko.applyBindings(new ThisPage())
        })
    </script>
  </div>
</div>
{% endblock %}
